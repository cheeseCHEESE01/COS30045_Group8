<html>
<header>
<title>Rice vs Roti</title>
</header>
<head>
<meta charset="utf-8">
<script src="https://d3js.org/d3.v5.min.js"></script>
<style>

body {
  display: flex;
  justify-content: center;
}

.active-state {
  fill: yellow !important; /* Override any other styles */
}


div.tooltip {	
    position: absolute;			
    text-align: center;			
    width: 150px;					
    height: 70px;					
    padding: 2px;
    font: 14px sans-serif;						
    background: #FFBF00;	
    border: 0px;			
    pointer-events: none;			
}

#map {
    border: 2px solid green;
    margin-top: 20px;
}

#right-clmn {
  margin-left: auto;
  margin-right: auto;
}

.legend {
  transform: translate(100px,50px);
}

.blegend {
  transform: translate(100px,100px);
}

.filtered {
    fill-opacity: 1 !important;
  }


</style>
</head>
<body>
  <!-- Add buttons for filtering -->

  <div id="map"></div>
  <div id="right-clmn">
    <div id="inner"></div>
    <label for="percentageToCheck">Filter by Percentage:</label>
    <input type="number" id="percentageToCheck" placeholder="Enter Percentage">
    <button onclick="applyFilter()">Filter Data</button>
  
    <div id="filteredData"></div>
  </div>
  

  <script>
    //let margin = {top: 10, right: 20, bottom: 10, left: 450};
    let margin = {top: 0, right: 0, bottom: 0, left: 0};

    let width = 1000 - margin.left - margin.right;
    let height = 650 - margin.top - margin.bottom;
    
    let svg = d3.select("#map").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      //.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
      //.attr("transform", "translate(0,0)");

          
    // map background
    svg.append("rect")
      .attr("width",width)
      .attr("height",height)
      .style("fill","green")
      .style("opacity", 0); //Background best practice
        
    let div = d3.select("body").append("div")	
      .attr("class", "tooltip")				
      .style("opacity", 0);
    
    let activeState = null;
    let clickedClass = "clicked";

    Promise.all([
      d3.json("india-states.json"),
      d3.csv("unemployment.csv")
    ]).then(function(data){
      let geoJsonData = data[0];
      let languageData = data[1];
      let projection = d3.geoMercator();
      projection.fitHeight(height-100,geoJsonData);
      let pathGenerator = d3.geoPath().projection(projection);
      
      <!-- Append map of India -->
      let india = svg.append('g');     
      india.selectAll('path')
        .data(geoJsonData.features)
        .enter()
        .append('path')
          .attr('d', pathGenerator)
          .attr("transform", "translate(0,50)")
          .style("fill", function(d) {
            if(d.State == "Kerala") {
              return "red";
            }
            return "back";
          })
          .style("stroke", "black")
          .on("click", function(d) {
            // Remove the initial translate transform from the Indian map
            india.selectAll('path')
            .attr("transform", "translate(0,0)")

            // Define a new zoom level (e.g., 2 for double zoom)
            const newZoomLevel = 2;
            
            // Calculate the new transform based on the clicked position
            const [x, y] = d3.mouse(this);
            const scale = newZoomLevel;
            const translate = [width / 2 - scale * x, height / 2 - scale * y];
            const transform = d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale);
            
            // Apply the new zoom transform
            svg.transition().duration(750)
            .call(zoom.transform, transform);

            /***************************************/


            // Remove active class from previously active state
           if (activeState !== null) {
            d3.select(activeState).classed("active-state", false);
          }

          d3.selectAll('.dynamic-text').remove();

          const textContent = `${d.State}: ${d.Unemployment_Percentage_in_2022}%`;
          const [x2, y2] = projection(d3.geoCentroid(d));

          svg.append("text")
            .attr("x", x2)
            .attr("y", y2)
            .text(textContent)
            .attr("transform", "translate(200,50)")
            .attr('class', 'dynamic-text');

          d3.select(this).classed("active-state", true);
            activeState = this;

          })
          .on("mouseover", function(d) {
            div.style("opacity", .9);		
            div.html("<b><span class='state-text'>" + d.State + "</span></b><br><br>" 
            + d.Unemployment_Percentage_in_2022 + "%")
            
            .style("left", (d3.event.pageX) + "px")		
            .style("top", (d3.event.pageY - 28) + "px");
            
            var originalFillColor = d3.select(this).style("fill");

            d3.select(this) // Select the hovered element
            .style("fill", "#F8C471"); // Change fill color to blue
            
            d3.select(".state-text")
            .style("font-size", "16px");

            // On mouseout, revert fill color to original
            d3.select(this)
            .on("mouseout", function(d) {		
            div.style("opacity", 0);
      
            d3.select(this)
            .style("fill", originalFillColor);
          });

          })					
          .on("mouseout", function(d) {		
            div.style("opacity", 0).style("fill", function(d) {
            if(d.State == "Kerala") {
              return "red";
            }
            return "back";
          })
          d3.select("#tooltip").remove()
          ;	
            
          });
      
      console.log("Bout to go off");

      /**************************************************/
      
      let colorScale = d3.scaleLinear()
        .domain([0, 5])
        .range(['#FFFFFF', '#E9967A']);
        
      /**************************************************/

      india.selectAll('path')
        .data(languageData)
        .style("fill", function(d) {
          let Unemployment_Percentage_in_2022 = d.Unemployment_Percentage_in_2022;
          
          return colorScale(Unemployment_Percentage_in_2022);
          //let team = d.team;
          /*if(Unemployment_Percentage_in_2022 >= 10) {
            return orangeScale(Unemployment_Percentage_in_2022);
          }
          return greenScale(Unemployment_Percentage_in_2022);
        });*/

            //return greenScale(Unemployment_Percentage_in_2022);
          });
              
      
      console.log("Went off");
                                  
    }) //End of Promise

    
    const zoom = d3.zoom()
            .scaleExtent([1, 5])
            .on("zoom", () => {
              svg.selectAll('g').attr('transform', d3.event.transform);
            });

        svg.call(zoom);

    /**************************************************/

    let colorScale = d3.scaleLinear()
        .domain([0, 5])
        .range(['#FFFFFF', '#E9967A']);

    let width2 = 380;
    let height2 = 200;
    let svg2 = d3.select("#inner").append("svg")
      .attr("width", width2 + margin.left + margin.right)
      .attr("height", height2 + margin.top + margin.bottom)
      .attr("transform", "translate(0,0)")
      .append("g");

      // Create a legend group
      let legend = svg2.append('g')
        .attr('class', 'legend')
        .attr('transform', 'translate(10, 10)'); // Adjust position as needed

      let blk_legend = svg2.append('g')
        .attr('class', 'blegend')
        .attr('transform', 'translate(10, 10)');

      // Define gradient
      let gradient = legend.append('defs')
        .append('linearGradient')
        .attr('id', 'colorGradient')
        .attr('x1', '0%')
        .attr('y1', '0%')
        .attr('x2', '100%')
        .attr('y2', '0%');

      gradient.append('stop')
        .attr('offset', '0%')
        .attr('style', 'stop-color:' + colorScale(1));

      gradient.append('stop')
        .attr('offset', '100%')
        .attr('style', 'stop-color:' + colorScale(10));

      // Create color bar rectangle
      legend.append('rect')
        .attr('width', 180) // Adjust the width of the legend
        .attr('height', 20) // Adjust the height of the legend
        .style('fill', 'url(#colorGradient)')
        .style('stroke', 'black');

      // Add text for lower range
      let lowerRangeText = legend.append('text')
        .attr('x', -90) // Adjust the x position to position the text
        .attr('y', 15) // Adjust the y position to position the text
        .text('Lower Range')
        .style('font-size', '15px');

      // Add text for higher range
      let higherRangeText = legend.append('text')
        .attr('x', 190) // Adjust the x position to position the text
        .attr('y', 15) // Adjust the y position to position the text
        .text('Higher Range')
        .style('font-size', '15px');

      // Create color bar rectangle
      blk_legend.append('rect')
        .attr('width', 100) // Adjust the width of the legend
        .attr('height', 20) // Adjust the height of the legend
        //.style('fill', 'url(#colorGradient)')
        .style('fill', 'black')
        .style('stroke', 'black');

      // Add text for lower range
      let blkText = blk_legend.append('text')
        .attr('x', 120) // Adjust the x position to position the text
        .attr('y', 15) // Adjust the y position to position the text
        .text('Undifined data')
        .style('font-size', '15px');


      /**************************************/
      // filter button

      function applyFilter() {
  d3.csv("unemployment.csv").then(function(data) {
    let filterValue = parseFloat(document.getElementById("percentageToCheck").value);

    let filteredData = data.filter(function(d) {
      return parseFloat(d.Unemployment_Percentage_in_2022) > filterValue;
    });

    let tableHTML = "<table><tr><th>State</th><th>Unemployment Percentage</th></tr>";
    filteredData.forEach(function(d) {
      tableHTML += "<tr><td>" + d.State + "</td><td>" + d.Unemployment_Percentage_in_2022 + "%</td></tr>";
    });
    tableHTML += "</table>";

    document.getElementById("filteredData").innerHTML = tableHTML;

    // Update map fill based on the filtered data
    india.selectAll('path')
      .data(geoJsonData.features)
      .style("fill", function(d) {
        let stateName = d.properties.name;
        let stateData = filteredData.find(item => item.State === stateName);

        if (stateData) {
          let Unemployment_Percentage_in_2022 = stateData.Unemployment_Percentage_in_2022;
          return colorScale(Unemployment_Percentage_in_2022);
        } else {
          return "back"; // Change this to your default color
        }
      });
  });
}





  </script>
  
  </div>
</body>
</html>
